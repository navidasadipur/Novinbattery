@model SpadStorePanel.Web.ViewModels.ProductListViewModel
@{
    ViewBag.Title = "فروشگاه";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var productgroupid = ViewBag.ProductGroupId;

}



@*<!-- breadcrumb area start -->
<section class="breadcrumb-area breadcrumb-bg extra">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb-inner">
                    <!-- breadcrumb inner -->
                    <div class="left-content-area">
                        <!-- left content area -->
                        <h1 class="title">@ViewBag.Title</h1>
                    </div><!-- //. left content area -->
                    <div class="right-content-area">
                        <ul>
                            <li><a href="/">خانه</a></li>
                            <li>@ViewBag.Title</li>
                        </ul>
                    </div>
                </div><!-- //. breadcrumb inner -->
            </div>
        </div>
    </div>
</section>
<!-- breadcrumb area end -->
<div class="body-overlay" id="body-overlay"></div>
<div class="search-popup" id="search-popup">
    <form action="#" class="search-popup-form">
        <div class="form-element">
            <input type="text" class="input-field" placeholder="جستجو.....">
        </div>
        <button type="submit" class="submit-btn"><i class="fas fa-search"></i></button>
    </form>
</div>

<!-- cart sidebar area start -->
<div class="cart-sidebar-area home-3" id="cart-sidebar-area">
    <div class="top-content">
        <!-- top content -->
        <a href="#" class="logo">
            <h3 class="text-white">آقای باتری</h3>
        </a>
        <span class="side-sidebar-close-btn"><i class="fas fa-times"></i></span>
    </div><!-- //. top content -->
    <div class="bottom-content">
        <!-- bottom content -->
        <div class="cart-products">
            <!-- cart product -->
            <h4 class="title">سبد خرید</h4>

            <h4 class="text-white">چیزی وجود ندارد</h4>

            <div class="btn-wrapper">
                <a href="cart.html" class="boxed-btn">بررسی و پرداخت</a>
            </div>
        </div> <!-- //. cart product -->
    </div><!-- //. bottom content -->
</div>
<!-- cart sidebar area end -->
<!-- category content area start -->
<div class="category-content-area">
    <div class="container">
        <div class="row">
            <div class="col-lg-3">
                @Html.Action("ProductGroupSection", "shop")
            </div>
            <div class="col-lg-9">
                <div class="right-content-area">
                    <!-- right content area -->
                    <div class="top-content">
                        <!-- top content -->
                        <div class="left-conent">
                            <span class="cat">باتری ماشین</span>
                        </div>
                        <div class="right-content">
                            <ul>

                                <li>
                                    <div class="form-element has-icon">
                                        <select name="sortby" id="sortby" class="selectpicker input-field select">
                                            <option value="High to low">مرتب سازی</option>
                                            <option value="Price">بر اساس قیمت</option>
                                            <option value="Name">بر اساس نام</option>
                                        </select>
                                        <div class="the-icon">
                                            <i class="fas fa-angle-down"></i>
                                        </div>
                                    </div>
                                </li>

                            </ul>
                        </div>
                    </div><!-- //. top content -->
                    <div class="bottom-content">
                        <!-- top content -->
                        <div class="row">
                            @foreach (var item in Model.ProductGroups)
                            {
                                <div class="col-lg-4 col-md-6">
                                    <div onclick=" window.location = '/Shop/Detail/@item.Id' " style="cursor: pointer;"
                                         class="single-new-collection-item">
                                        <!-- single new collections -->
                                        <div class="thumb">
                                            <img src="/Files/ProductImages/Image/@item.Image" alt="new collcetion image">
                                            <div class="hover">
                                                <a href="/Shop/Detail/@item.Id" class="addtocart">دیدن محصول</a>
                                            </div>
                                        </div>
                                        <div class="content">
                                            <a href="/Shop/Detail/@item.Id">
                                                <h4 class="title">@item.Title</h4>
                                            </a>
                                            <div class="price mt-3">
                                                <span class="sprice">
                                                    @item.Price.ToString("##,###")
                                                    تومان
                                                </span>
                                            </div>
                                        </div>
                                    </div><!-- //. single new collections  -->
                                </div>
                            }
                        </div>
                    </div><!-- //.top content -->
                </div><!-- //. right content area -->
            </div>
        </div>
    </div>
</div>
<!-- category content area end -->*@



<!-- breadcrumb area start -->
<section class="breadcrumb-area breadcrumb-bg extra">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb-inner">
                    <!-- breadcrumb inner -->
                    <div class="left-content-area">
                        <!-- left content area -->
                        <h1 class="title">@ViewBag.Title</h1>
                    </div><!-- //. left content area -->
                    <div class="right-content-area">
                        <ul>
                            <li><a href="/">خانه</a></li>
                            <li>@ViewBag.Title</li>
                        </ul>
                    </div>
                </div><!-- //. breadcrumb inner -->
            </div>
        </div>
    </div>
</section>
<!-- breadcrumb area end -->
<!-- category content area start -->
<div class="category-content-area">
    <div class="container">
        <div class="row">
            <div class="col-lg-3">
                <div class="category-sidebar">
                    <!-- category sidebar -->
                    <div class="category-filter-widget">
                        <!-- category-filter-widget -->
                        <h4 class="title">فیلتر بر اساس</h4>
                        <div class="accordion accordion-flush" id="accordionFlushExample">
                            @if (Model.Features.Count() > 0)
                            {
                                foreach (var feature in Model.Features)
                                {
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="flush-headingOne">
                                            <button class="accordion-button collapsed" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#flush-collapse-@feature.Id"
                                                    aria-expanded="false" aria-controls="flush-collapseOne">
                                                @feature.Title
                                            </button>
                                        </h2>
                                        <div id="flush-collapse-@feature.Id" class="accordion-collapse collapse"
                                             aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                                            <div class="accordion-body">
                                                <ul>
                                                    @if (feature.SubFeatures != null)
                                                    {
                                                        foreach (var item in feature.SubFeatures)
                                                        {
                                                            <li>
                                                                <a class="liitem" href="javascript:void(0)" onclick="GetGrid(null, null, null, @item.Id)">@item.Value</a>
                                                            </li>
                                                        }
                                                    }
                                                    @*else if (feature.ProductFeatureValues != null)
                                                    {
                                                        foreach (var item in feature.ProductFeatureValues)
                                                        {
                                                            <li>
                                                                <a class="liitem" href="javascript:void(0)" onclick="GetGrid(null, null, null, @item.Id)">@item.Value</a>
                                                            </li>
                                                        }
                                                    }*@
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }

                            @if (Model.Brands.Count() > 0)
                            {
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="flush-headingTwo">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo"
                                                aria-expanded="false" aria-controls="flush-collapseTwo">
                                            برند
                                        </button>
                                    </h2>
                                    <div id="flush-collapseTwo" class="accordion-collapse collapse"
                                         aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
                                        <div class="accordion-body">
                                            <ul>
                                                @foreach (var item in Model.Brands)
                                                {
                                                    <li>
                                                        <a class="liitem" href="javascript:void(0)" onclick="GetGrid(null, null, @item.Id)" id="b_@item.Id" value="@item.Id">@item.Name</a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (Model.ProductGroups.Count() > 0)
                            {
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="flush-headingThree">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#flush-collapseThree"
                                                aria-expanded="false" aria-controls="flush-collapseThree">
                                            مدل خودرو
                                        </button>
                                    </h2>
                                    <div id="flush-collapseThree" class="accordion-collapse collapse"
                                         aria-labelledby="flush-headingThree" data-bs-parent="#accordionFlushExample">
                                        <div class="accordion-body">
                                            <ul>
                                                @foreach (var item in Model.ProductGroups)
                                                {
                                                    <li>
                                                        <a class="liitem" href="javascript:void(0)" onclick="GetGrid(null, @item.Id)">@item.Title</a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div><!-- //.category-filter-widget -->
                </div><!-- //. category sidebar -->

            </div>
            <div class="col-lg-9">
                <div class="right-content-area">
                    <!-- right content area -->
                    <div class="top-content">
                        <!-- top content -->
                        <div class="left-conent">
                            <span class="cat">نوین باطری</span>
                        </div>
                        <div class="right-content">
                            <ul>
                                <li>
                                    <div class="form-element has-icon">
                                        @*<select class="selectpicker input-field select">
                                            <option value="0">نمایش</option>
                                            <option value="2">مخفی</option>
                                            <option value="1">نمایش</option>
                                        </select>
                                        <div class="the-icon">
                                            <i class="fas fa-angle-down"></i>
                                        </div>*@
                                            <select onchange="GetGrid()" name="take" id="take" class="selectpicker input-field select">
                                                <option value="27" selected="selected">نمایش 27 محصول</option>
                                                <option value="15">نمایش 15 محصول</option>
                                                <option value="9">نمایش 9 محصول</option>
                                            </select>
                                        <div class="the-icon">
                                            <i class="fas fa-angle-down"> </i>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    @*<div class="form-element has-icon">
                                        <select class="selectpicker input-field select">
                                            <option value="0">فیلتر بر اساس</option>
                                            <option value="2">قیمت</option>
                                            <option value="1">رتبه بندی</option>
                                        </select>
                                        <div class="the-icon">
                                            <i class="fas fa-angle-down"></i>
                                        </div>
                                    </div>*@
                                    <div class="form-element has-icon">
                                        <select onchange="GetGrid()" name="sort" id="sort" class="selectpicker input-field select">
                                            <option value="date" selected="selected">نمایش بر اساس تاریخ ثبت</option>
                                            <option value="name">نمایش بر اساس اسم محصول</option>
                                            <option value="price-high-to-low">نمایش بر اساس قیمت از زیاد به کم </option>
                                            <option value="price-low-to-high">نمایش بر اساس قیمت از کم به زیاد</option>
                                            <option value="sale">نمایش بر اساس پر فروش ها</option>
                                        </select>
                                        <div class="the-icon">
                                            <i class="fas fa-angle-down"></i>
                                        </div>
                                    </div><!-- End .toolbox-sort -->
                                </li>

                            </ul>
                        </div>
                    </div><!-- //. top content -->
                    <div class="bottom-content" id="grid">

                    </div><!-- //.top content -->
                </div><!-- //. right content area -->
                </div>
            </div>
        </div>
    </div>
    <!-- category content area end -->

    @Html.Action("NewBlog", "blog")



    @section scripts{



        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
                crossorigin="anonymous"></script>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
                integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc"
                crossorigin="anonymous"></script>


        <script>
            document.getElementById('sortby').addEventListener('change', function () {
                val = $("#sortby").val();

                console.log(val)
                //if (val === 'popularity') {
                //    window.open('popularity', '_blank');
                //}

                if (val === 'Price') {
                    //window.open('/Price', '_blank');
                    ProductGroupId = $("#ProductGroupId").text();
                    //alert(ProductGroupId);
                    window.location.href = "/Shop/Price?ProductGroupId=" + ProductGroupId;

                }
                if (val === 'Name') {
                    //window.open('rating', '_blank');
                    ProductGroupId = $("#ProductGroupId").text();
                    window.location.href = "/Shop/Name?ProductGroupId=" + ProductGroupId;

                }
            });

        </script>
        <script>
            var brandIds = null;
            var groupIds = null;
            var productIds = null;
        </script>

        @if (ViewBag.brandIds != null)
        {
            <script>
            brandIds = "@ViewBag.BrandIds";
            </script>
        }
        @if (ViewBag.groupIds != null)
        {
            <script>
            groupIds = "@ViewBag.GroupIds";
            </script>
        }
        @if (ViewBag.productIds != null)
        {
            <script>
            productIds = "@ViewBag.ProductIds";
            </script>
        }
        <script>
        var selectedGroupId = @Model.SelectedGroupId;

        function GetGrid(page, groupId, brandId, subFearueId) {
            $("#preloader").show();
            var pageNumber = 1;
            if (page != null) {
                pageNumber = page;
            }
            var sort = $("#sort").find(":selected").val();
            var take = $("#take").find(":selected").val();
            var categoryId = groupId !== undefined ? groupId : null;
            categoryId = categoryId === null ? selectedGroupId : categoryId;
            brandId = brandId !== undefined ? brandId : null;
            subFearueId = subFearueId !== undefined ? subFearueId : null;
            var searchString =  '@ViewBag.SearchString';

            var priceFrom = null;
            var priceTo = null;
            var selectedPriceRange = $("span#filter-price-range").text().replaceAll("تومان", "");
            if (selectedPriceRange != undefined) {
                var priceRangeArr = selectedPriceRange.split('-');
                 console.log(priceRangeArr);
                if (parseInt(priceRangeArr[0]) > 0) {
                    priceFrom = parseInt(priceRangeArr[0]);
                    console.log(priceFrom);
                }
                if (parseInt(priceRangeArr[1]) > 0) {
                    priceTo = parseInt(priceRangeArr[1]);
                    console.log(priceTo);
                }
            }

            var brands = [];
            brands.push(brandId);
            //$("input[name='brands']").map(function() {
            //    if ($(this).prop("checked") === true) {
            //        brands.push(parseInt($(this).val()));
            //    }
            //});

            var subFeatures = [];
            subFeatures.push(subFearueId);
            //subFeatures.push(subFearueId);
            //$("[name='subFeatures']").map(function() {
            //    if ($(this).prop("checked") === true) {
            //        subFeatures.push(parseInt($(this).val()));
            //    }
            //});

            var grid = {
                CategoryId: categoryId,
                BrandId: brandId,
                SubFeatureId: subFearueId,
                SearchString: searchString,
                PriceFrom: priceFrom,
                PriceTo: priceTo,
                Brands: brands.join('-'),
                SubFeatures: subFeatures.join('-'),
                PageNumber: pageNumber,
                Take: take,
                Sort: sort,
                BrandIds: brandIds,
                GroupIds: groupIds,
                ProductIds: productIds,
            }
            $.ajax({
                type: 'GET',
                url: '/Shop/ProductsGrid',
                data: grid,
                success: function(data) {
                    $("#grid").html(data);
                },
                error: function(data) {
                    console.log("error");
                    console.log(data);
                },
                complete: function() {
                    $("#preloader").hide();
                }
            });
        }

        $(document).ready(function() {
            GetGrid();

            //$("#filter-price-range").on('DOMSubtreeModified', function () {
            //    alert("Span HTML is now " + $(this).html());
            //    GetGrid();
            //});

            // Update Price Range
            $('#price-slider').mouseup(function () {
                GetGrid();
            });

            document.getElementById("reload").onclick = function() {reload()};


        });
                function reload() {
                window.location = window.location.href.split("?")[0];
            }

                    function CheckPriceUpdated() {
        var newMintxt = $('.from').text();
        var newMaxtxt = $('.to').text();

        var newMin = newMintxt.substring(1);
        var newMax = newMaxtxt.substring(1);

        if (newMin != minPrice || newMax != maxPrice) {
            minPrice = newMin;
            maxPrice = newMax;

            searchString = "";
            $('.search-field').val(searchString);

            submitForm();
        }
    }
        </script>

    }
